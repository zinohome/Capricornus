{"version":3,"sources":["components/date-picker/shadow-dom-events-plugin.ts"],"names":["on","find","moveDateForKeys","ArrowLeft","Left","ArrowUp","Up","ArrowRight","Right","ArrowDown","Down","moveMonthForKeys","MILLISECONDS_IN_DAY","adjustDate","localDate","date","moveDate","utcDate","Date","UTC","getFullYear","getMonth","getDate","getUTCFullYear","getUTCMonth","getUTCDate","fp","getDateElem","daysContainer","firstElementChild","children","dateObj","getTime","handleKeydown","event","ctrlKey","key","target","dispatchEvent","Object","assign","CustomEvent","bubbles","which","movedDate","movedDateElem","focus","innerDaysContainer","changeMonth","lastElementChild","preventDefault","release","_hBXCEDatePickerShadowDOMEventsPluginKeydown","init","calendarContainer","register","loadedPlugins","push","onReady","onDestroy"],"mappings":"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","sourcesContent":["/**\n * @license\n *\n * Copyright IBM Corp. 2019\n *\n * This source code is licensed under the Apache-2.0 license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\nimport { Instance as FlatpickrInstance } from 'flatpickr/dist/types/instance';\nimport { Plugin } from 'flatpickr/dist/types/options';\nimport on from 'carbon-components/es/globals/js/misc/on';\nimport Handle from '../../globals/internal/handle';\nimport { find } from '../../globals/internal/collection-helpers';\n\n/**\n * `FlatpickrInstance` with additional properties used for `carbonFlatpickrShadowDOMEventsPlugin`.\n */\nexport interface ExtendedFlatpickrInstanceShadowDOMEventsPlugin extends FlatpickrInstance {\n  /**\n   * The handle for `keydown` event handler in calendar dropdown.\n   */\n  _hBXCEDatePickerShadowDOMEventsPluginKeydown?: Handle | null;\n}\n\n/**\n * The amount of days to adjust, keyed by the key code.\n */\nconst moveDateForKeys = {\n  ArrowLeft: -1,\n  Left: -1,\n  ArrowUp: -7,\n  Up: -7,\n  ArrowRight: 1,\n  Right: 1,\n  ArrowDown: 7,\n  Down: 7,\n};\n\n/**\n * The amount of months to adjust, keyed by the key code. Used with Ctrl modifier key.\n */\nconst moveMonthForKeys = {\n  ArrowLeft: -1,\n  Left: -1,\n  ArrowUp: -12,\n  Up: -12,\n  ArrowRight: 1,\n  Right: 1,\n  ArrowDown: 12,\n  Down: 12,\n};\n\n/**\n * The number of milliseconds per day.\n */\nconst MILLISECONDS_IN_DAY = 86400000;\n\n/**\n * Adjusts the date with the given amount of days.\n * @param localDate The original date.\n * @param options The options.\n * @param [options.date=0] The amount of days to adjust.\n */\nconst adjustDate = (localDate: Date, { date: moveDate = 0 }: { date?: number }) => {\n  const utcDate = new Date(\n    Date.UTC(localDate.getFullYear(), localDate.getMonth(), localDate.getDate()) + moveDate * MILLISECONDS_IN_DAY\n  );\n  return new Date(utcDate.getUTCFullYear(), utcDate.getUTCMonth(), utcDate.getUTCDate());\n};\n\n/**\n * @param config Plugin configuration.\n * @returns\n *   A Flatpickr plugin to handle events.\n *   Some event handlers in Flatpickr won't work is the calendar dropdown is put in shadow DOM, due to event retargetting.\n */\nexport default (): Plugin => (fp: ExtendedFlatpickrInstanceShadowDOMEventsPlugin) => {\n  const getDateElem = localDate =>\n    find(fp.daysContainer!.firstElementChild!.children, ({ dateObj }: any) => localDate.getTime() === dateObj.getTime());\n\n  /**\n   * Handles `keydown` event.\n   */\n  const handleKeydown = (event: KeyboardEvent) => {\n    const { ctrlKey, key, target } = event;\n    if (key === 'Enter') {\n      target!.dispatchEvent(Object.assign(new CustomEvent('mousedown', { bubbles: true }), { which: 1 }));\n    } else if (!ctrlKey && key in moveDateForKeys) {\n      const { dateObj } = target as any;\n      const movedDate = adjustDate(dateObj, { date: moveDateForKeys[key] });\n      const movedDateElem = getDateElem(movedDate);\n      if (movedDateElem) {\n        movedDateElem.focus();\n      } else {\n        const innerDaysContainer = fp.daysContainer!.firstElementChild!;\n        if (movedDate.getTime() < (innerDaysContainer.firstElementChild as any).dateObj.getTime()) {\n          fp.changeMonth(-1);\n          // `fp.daysContainer` is updated by `fp.changeMonth()`\n          (fp.daysContainer!.firstElementChild!.lastElementChild as HTMLElement).focus();\n        } else if (movedDate.getTime() > (innerDaysContainer.lastElementChild as any).dateObj.getTime()) {\n          fp.changeMonth(1);\n          // `fp.daysContainer` is updated by `fp.changeMonth()`\n          (fp.daysContainer!.firstElementChild!.firstElementChild as HTMLElement).focus();\n        }\n      }\n      event.preventDefault();\n    } else if (ctrlKey && key in moveMonthForKeys) {\n      fp.changeMonth(moveMonthForKeys[key]);\n      (fp.daysContainer!.firstElementChild!.firstElementChild as HTMLElement).focus();\n      event.preventDefault();\n    }\n  };\n\n  /**\n   * Releases event listeners used in this Flatpickr plugin.\n   */\n  const release = () => {\n    if (fp._hBXCEDatePickerShadowDOMEventsPluginKeydown) {\n      fp._hBXCEDatePickerShadowDOMEventsPluginKeydown = fp._hBXCEDatePickerShadowDOMEventsPluginKeydown.release();\n    }\n  };\n\n  /**\n   * Sets up event listeners used for this Flatpickr plugin.\n   */\n  const init = () => {\n    release();\n    fp._hBXCEDatePickerShadowDOMEventsPluginKeydown = on(fp.calendarContainer, 'keydown', handleKeydown);\n  };\n\n  /**\n   * Registers this Flatpickr plugin.\n   */\n  const register = () => {\n    fp.loadedPlugins.push('carbonFlatpickrShadowDOMEventsPlugin');\n  };\n\n  return {\n    onReady: [register, init],\n    onDestroy: [release],\n  };\n};\n"],"file":"shadow-dom-events-plugin.js"}